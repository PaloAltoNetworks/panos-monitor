{% extends 'base.html' %}

{% block content %}
<style>
/* ** NEW: Change link color to match brand theme ** */
  .table-container a {
      color: #ff4500;
  }
</style>

<h2>Firewall Status Dashboard</h2>

<div class="grid">
    <div></div>
    <div>
        <input type="search" id="searchInput" placeholder="Filter by name, IP, or model..." style="margin-bottom: 0;">
    </div>
    <div style="text-align: right;">
        <form action="{{ url_for('trigger_poll') }}" method="post" style="margin: 0;">
            <button type="submit" class="btn-small btn-panw">Refresh Now</button>
        </form>
    </div>
</div>

<div class="table-container">
    <table id="firewallTable">
        <thead>
            <tr>
                <th>Device-Name</th>
                <th>IP Address</th>
                <th>Model</th>
                {# ** NEW: Added Generation column header ** #}
                <th>Generation</th>
                <th>Last Updated</th>
                <th>Active Sessions</th>
                <th>CPU Load</th>
                <th>DP Load</th>
                <th>Total Input</th>
                <th>Total Output</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in stats %}
            <tr>
                <td>
                    <strong>
                        <a href="{{ url_for('firewall_detail', fw_id=stat.firewall_id) }}">{{ stat.hostname or 'N/A' }}</a>
                    </strong>
                </td>
                <td><a href="{{ url_for('firewall_detail', fw_id=stat.firewall_id) }}">{{ stat.ip_address }}</a></td>
                <td>{{ stat.model or 'Discovering...' }}</td>
                {# ** NEW: Added Generation data cell ** #}
                <td>{{ stat.generation }}</td>
                <td>{{ stat.timestamp or 'N/A' }}</td>
                <td>{{ stat.active_sessions or 'N/A' }}</td>
                <td>{{ stat.cpu_load | round(2) }}%</td>
                <td>{{ stat.dataplane_load | round(2) }}%</td>
                <td>{{ (stat.total_input_mbps | default(0)) | round(2) }} Mbps</td>
                <td>{{ (stat.total_output_mbps | default(0)) | round(2) }} Mbps</td>
                <td>
                    {% if stat.status == 'success' %}
                        <span style="color: green;">● Online</span>
                    {% elif stat.status == 'error' %}
                        <span style="color: red;">○ Error</span>
                    {% else %}
                        <span style="color: gray;">- Pending</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            {# **CHANGE**: Updated colspan to account for the new column #}
            <td colspan="11">No statistics found. Add some firewalls and wait for the poller to run.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    
<script>
    setTimeout(() => {
        window.location.reload();
    }, {{ polling_interval * 1000 }});

    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('firewallTable');
    const tableRows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    function applyFilter() {
        const filterValue = searchInput.value.toUpperCase();
        for (let i = 0; i < tableRows.length; i++) {
            const hostnameCell = tableRows[i].getElementsByTagName('td')[0];
            const ipCell = tableRows[i].getElementsByTagName('td')[1];
            const modelCell = tableRows[i].getElementsByTagName('td')[2];

            if (hostnameCell && ipCell && modelCell) {
                const rowText = (hostnameCell.textContent || hostnameCell.innerText) +
                                (ipCell.textContent || ipCell.innerText) +
                                (modelCell.textContent || modelCell.innerText);

                if (rowText.toUpperCase().indexOf(filterValue) > -1) {
                    tableRows[i].style.display = "";
                } else {
                    tableRows[i].style.display = "none";
                }
            }
        }
    }

    // --- NEW: Save filter to localStorage on keyup ---
    searchInput.addEventListener('keyup', function() {
        localStorage.setItem('firewallFilter', searchInput.value);
        applyFilter();
    });

    // --- NEW: Load filter from localStorage on page load ---
    document.addEventListener('DOMContentLoaded', function() {
        const savedFilter = localStorage.getItem('firewallFilter');
        if (savedFilter) {
            searchInput.value = savedFilter;
            applyFilter();
        }
    });

</script>

{% endblock %}